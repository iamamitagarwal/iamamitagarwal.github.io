<!-- _includes/whatsnext_and_contact.html -->
<script>
(function(){
  /* Compute a safe top offset for the panel so it never clips behind masthead */
  function mastheadTop(){
    const m = document.querySelector('.masthead');
    const h = m ? m.getBoundingClientRect().height : 72;   // default ~72px
    return Math.round(h + 12); // 12px breathing room
  }

  // Build the tab + panel markup
  const tab = document.createElement('button');
  tab.className = 'wnx-tab';
  tab.type = 'button';
  tab.innerHTML = '<span>What’s next</span>';

  const panel = document.createElement('div');
  panel.className = 'wnx-panel';
  panel.style.top = mastheadTop() + 'px';

  panel.innerHTML = `
    <div class="wnx-head">
      <span>What’s next</span>
      <button type="button" class="wnx-close">Close</button>
    </div>
    <div class="wnx-body">
      <div class="wnx-list">
        {% assign feed = site.data.whats_next %}
        {% if feed and feed.size > 0 %}
          {% for it in feed %}
          <div class="wnx-card">
            <div class="wnx-title">{{ it.title }}</div>
            <div class="wnx-meta">
              {{ it.tag | default: "" }}{% if it.when %} • {{ it.when }}{% endif %}
            </div>
            {% if it.desc and it.desc != "" %}
              <div class="wnx-text" style="margin-top:6px;color:#64748b;">{{ it.desc }}</div>
            {% endif %}
            {% if it.link %}
              <div style="margin-top:8px;">
                <a href="{{ it.link }}" target="_blank" rel="noopener" class="link-pill" style="text-decoration:none;padding:.28rem .65rem;border-radius:999px;border:1px solid #0ea5e9;">Open</a>
              </div>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <div class="wnx-card"><div class="wnx-title">No items yet.</div></div>
        {% endif %}
      </div>
    </div>
  `;

  // Default: collapsed
  document.body.appendChild(tab);
  document.body.appendChild(panel);

  const open = () => panel.classList.add('open');
  const close = () => panel.classList.remove('open');
  tab.addEventListener('click', open);
  panel.querySelector('.wnx-close').addEventListener('click', close);

  // Recompute top on resize (avoids clipping if header height changes)
  let rAF = null;
  window.addEventListener('resize', function(){
    if (rAF) cancelAnimationFrame(rAF);
    rAF = requestAnimationFrame(()=>{ panel.style.top = mastheadTop() + 'px'; });
  });

  /* ---- Contact FAB + Drawer (Formspree) ---------------------------------- */
  const fab = document.createElement('button');
  fab.className = 'contact-fab';
  fab.type = 'button';
  fab.innerHTML = `
    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="26" height="26">
      <path d="M20 4H4a2 2 0 0 0-2 2v.35l10 6.25L22 6.35V6a2 2 0 0 0-2-2Zm0 4.88-8 5-8-5V18a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.88Z"/>
    </svg>
  `;
  document.body.appendChild(fab);

  const drawer = document.createElement('form');
  drawer.className = 'contact-drawer';
  drawer.action = 'https://formspree.io/f/mwpydbpb';
  drawer.method = 'POST';
  drawer.style.cssText = 'position:fixed;right:16px;bottom:84px;width:320px;max-width:90vw;max-height:80vh;background:var(--mm-card-bg,#fff);color:inherit;border:1px solid var(--mm-border,#e5e7eb);border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.18);transform:translateY(12px);opacity:0;pointer-events:none;transition:transform .16s ease,opacity .16s ease;z-index:998;display:flex;flex-direction:column;';
  drawer.innerHTML = `
    <div class="cd-head" style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--mm-border,#e5e7eb);font-weight:800;">
      <span>Say hi</span>
      <button class="btn-pill" type="button" id="contactClose" style="border:1px solid var(--mm-border,#e5e7eb);background:transparent;border-radius:999px;padding:.35rem .8rem;font-weight:800;cursor:pointer;">Close</button>
    </div>
    <div class="cd-body" style="padding:12px;display:grid;gap:10px;">
      <label style="display:block;">
        <span style="display:block;font-weight:800;margin-bottom:4px;color:#64748b;">Name</span>
        <input name="name" autocomplete="name" style="width:100%;border:1px solid var(--mm-border,#e5e7eb);background:transparent;border-radius:10px;padding:10px;"/>
      </label>
      <label style="display:block;">
        <span style="display:block;font-weight:800;margin-bottom:4px;color:#64748b;">Email</span>
        <input type="email" name="email" autocomplete="email" required style="width:100%;border:1px solid var(--mm-border,#e5e7eb);background:transparent;border-radius:10px;padding:10px;"/>
      </label>
      <label style="display:block;">
        <span style="display:block;font-weight:800;margin-bottom:4px;color:#64748b;">Subject</span>
        <input name="subject" style="width:100%;border:1px solid var(--mm-border,#e5e7eb);background:transparent;border-radius:10px;padding:10px;"/>
      </label>
      <label style="display:block;">
        <span style="display:block;font-weight:800;margin-bottom:4px;color:#64748b;">Message</span>
        <textarea name="message" rows="5" required style="width:100%;border:1px solid var(--mm-border,#e5e7eb);background:transparent;border-radius:10px;padding:10px;"></textarea>
      </label>
    </div>
    <div class="cd-actions" style="display:flex;justify-content:flex-end;gap:8px;padding:10px 12px 12px;">
      <button class="btn-pill" type="button" id="contactCancel" style="border:1px solid var(--mm-border,#e5e7eb);background:transparent;border-radius:999px;padding:.45rem .9rem;font-weight:800;cursor:pointer;">Cancel</button>
      <button class="btn-pill" type="submit" style="border:1px solid transparent;background:#0ea5e9;color:#fff;border-radius:999px;padding:.45rem .9rem;font-weight:800;cursor:pointer;">Send</button>
    </div>
  `;
  document.body.appendChild(drawer);

  function openDrawer(){ drawer.style.transform='translateY(0)'; drawer.style.opacity='1'; drawer.style.pointerEvents='auto'; }
  function closeDrawer(){ drawer.style.transform='translateY(12px)'; drawer.style.opacity='0'; drawer.style.pointerEvents='none'; }
  fab.addEventListener('click', openDrawer);
  drawer.querySelector('#contactClose').addEventListener('click', closeDrawer);
  drawer.querySelector('#contactCancel').addEventListener('click', closeDrawer);
})();
</script>
