{%- assign items = site.data.whats_next | default: site.data.whatsnext | default: empty -%}
<style>
  /* ---------- FABs ---------- */
  .mm-fab{
    position:fixed; right:16px; bottom:16px; z-index:9998;
    width:48px; height:48px; border-radius:999px; display:grid; place-items:center;
    border:1px solid var(--mm-fab-brd,#cbd5e1);
    background:var(--mm-fab-bg,#fff); color:var(--mm-fab-fg,#111827);
    box-shadow:0 10px 18px rgba(0,0,0,.12),0 1px 3px rgba(0,0,0,.06);
    cursor:pointer;
  }
  html.theme-dark .mm-fab{
    --mm-fab-bg:#0f172a; --mm-fab-fg:#e5e7eb; --mm-fab-brd:#334155;
  }
  /* keep theme button from overlapping the contact FAB when it has to float */
  #theme-toggle.floating{ right:72px !important; bottom:16px !important; }

  /* ---------- Contact drawer ---------- */
  .mm-drawer{
    position:fixed; top:0; right:0; height:100%; width:380px; max-width:92vw;
    background:var(--mm-drawer-bg,#fff); color:var(--mm-drawer-fg,#111827);
    border-left:1px solid var(--mm-drawer-brd,#e5e7eb);
    box-shadow:-20px 0 40px rgba(0,0,0,.18);
    transform:translateX(110%); transition:transform .22s ease;
    z-index:9997; display:flex; flex-direction:column;
  }
  html.theme-dark .mm-drawer{
    --mm-drawer-bg:#0b1220; --mm-drawer-fg:#e5e7eb; --mm-drawer-brd:#1f2937;
  }
  .mm-drawer.open{ transform:translateX(0); }
  .mm-drawer header{ display:flex; justify-content:space-between; align-items:center;
    padding:.9rem 1rem; border-bottom:1px solid var(--mm-drawer-brd);
    position:sticky; top:0; background:inherit; z-index:1; }
  .mm-drawer form{ padding:1rem; display:grid; gap:.75rem; }
  .mm-drawer label{ font-weight:700; font-size:.92rem; }
  .mm-drawer input, .mm-drawer textarea{
    width:100%; border:1px solid var(--mm-drawer-brd); border-radius:10px;
    padding:.6rem .7rem; background:transparent; color:inherit;
  }
  .mm-drawer textarea{ min-height:140px; resize:vertical; }
  .mm-row{ display:grid; gap:.6rem; }
  .mm-actions{ display:flex; gap:.6rem; justify-content:flex-end; padding:0 1rem 1rem; }
  .mm-btn{ border:1px solid #cbd5e1; padding:.45rem .8rem; border-radius:10px; font-weight:800; }
  .mm-btn--primary{ background:#1992c8; color:#fff; border-color:#1992c8; }
  html.theme-dark .mm-btn{ border-color:#334155; }

  /* Mobile bottom sheet behaviour for the drawer */
  @media (max-width: 640px){
    .mm-drawer{ width:100%; max-width:none; height:60vh; top:auto; bottom:0;
      border-left:none; border-top:1px solid var(--mm-drawer-brd); transform:translateY(110%);
    }
    .mm-drawer.open{ transform:translateY(0); }
  }

  /* ---------- What's next panel ---------- */
  .mm-whatsnext{
    position:fixed; right:16px; top:110px; width:360px; max-width:92vw;
    z-index:9996; transition:transform .22s ease, opacity .22s ease;
  }
  .mm-wn-card{
    background:var(--mm-wn-bg,#fff); color:var(--mm-wn-fg,#111827);
    border:1px solid var(--mm-wn-brd,#e5e7eb);
    border-radius:16px; box-shadow:0 10px 18px rgba(0,0,0,.10);
    overflow:hidden;
  }
  html.theme-dark .mm-wn-card{
    --mm-wn-bg:#0b1220; --mm-wn-fg:#e5e7eb; --mm-wn-brd:#1f2937;
  }
  .mm-wn-head{ display:flex; justify-content:space-between; align-items:center; padding:.8rem 1rem; }
  .mm-wn-list{ padding:0 1rem 1rem; display:grid; gap:.7rem; }
  .mm-wn-item{ border:1px solid var(--mm-wn-brd); border-radius:14px; padding:.8rem; background:transparent; }
  .mm-wn-item h4{ margin:0 0 .25rem; }
  .mm-wn-meta{ display:flex; gap:.5rem; align-items:center; color:#64748b; font-weight:700; font-size:.86rem; }
  .mm-wn-tag{ padding:.1rem .5rem; border-radius:999px; border:1px solid var(--mm-wn-brd); }
  .mm-wn-collapsed{ transform:translateY(-8px); opacity:.0; pointer-events:none; }
  @media (max-width: 1024px){ .mm-whatsnext{ display:none; } } /* hide on small screens */
</style>

<!-- Whats next (desktop) -->
<div class="mm-whatsnext" id="mm-whatsnext">
  <div class="mm-wn-card">
    <div class="mm-wn-head">
      <strong>What’s next</strong>
      <button class="mm-btn" id="mm-wn-toggle" type="button">Collapse</button>
    </div>
    <div class="mm-wn-list" id="mm-wn-list">
      {%- if items and items.size > 0 -%}
        {%- for it in items -%}
          <article class="mm-wn-item">
            <h4>
              {%- if it.link -%}<a href="{{ it.link }}" target="_blank" rel="noopener">{{ it.title }}</a>
              {%- else -%}{{ it.title }}{%- endif -%}
            </h4>
            {%- if it.desc %}<div style="margin:.25rem 0 .4rem; color:#475569">{{ it.desc }}</div>{% endif -%}
            <div class="mm-wn-meta">
              {%- if it.when %}<span>{{ it.when }}</span>{% endif -%}
              {%- if it.tag %}<span class="mm-wn-tag">{{ it.tag }}</span>{% endif -%}
            </div>
          </article>
        {%- endfor -%}
      {%- else -%}
        <article class="mm-wn-item"><em>Add items to <code>_data/whats_next.yml</code>.</em></article>
      {%- endif -%}
    </div>
  </div>
</div>

<!-- Contact FAB (bottom-right) -->
<button class="mm-fab" id="mm-contact-fab" aria-label="Contact form" title="Contact me">✉️</button>

<!-- Drawer -->
<aside class="mm-drawer" id="mm-contact-drawer" aria-hidden="true">
  <header>
    <strong>Say hi</strong>
    <button class="mm-btn" id="mm-contact-close" type="button">Close</button>
  </header>

  <!-- Formspree form -->
  <form action="https://formspree.io/f/mwpydbpb" method="POST">
    <div class="mm-row">
      <label for="mm-name">Name</label>
      <input id="mm-name" name="name" type="text" autocomplete="name" required />
    </div>
    <div class="mm-row">
      <label for="mm-email">Email</label>
      <input id="mm-email" name="email" type="email" autocomplete="email" required />
    </div>
    <div class="mm-row">
      <label for="mm-subject">Subject</label>
      <input id="mm-subject" name="subject" type="text" />
    </div>
    <div class="mm-row">
      <label for="mm-message">Message</label>
      <textarea id="mm-message" name="message" placeholder="Ideas, collab, or any question…"></textarea>
    </div>
    <div class="mm-actions">
      <button class="mm-btn" type="button" id="mm-contact-cancel">Cancel</button>
      <button class="mm-btn mm-btn--primary" type="submit">Send</button>
    </div>
    <!-- Optional spam honeypot -->
    <input type="text" name="_gotcha" style="display:none" tabindex="-1" autocomplete="off">
  </form>
</aside>

<script>
(function(){
  // ---------- Contact drawer ----------
  const fab   = document.getElementById('mm-contact-fab');
  const panel = document.getElementById('mm-contact-drawer');
  const closeBtn = document.getElementById('mm-contact-close');
  const cancelBtn= document.getElementById('mm-contact-cancel');

  function openDrawer(){ panel.classList.add('open'); panel.setAttribute('aria-hidden','false'); }
  function closeDrawer(){ panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); }

  fab?.addEventListener('click', openDrawer);
  closeBtn?.addEventListener('click', closeDrawer);
  cancelBtn?.addEventListener('click', closeDrawer);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

  // ---------- What's next ----------
  const wn = document.getElementById('mm-whatsnext');
  const wnList = document.getElementById('mm-wn-list');
  const toggle = document.getElementById('mm-wn-toggle');
  const LS_KEY = 'mm_wn_collapsed';

  function setCollapsed(collapsed){
    if(!wn) return;
    if(collapsed){ wn.classList.add('mm-wn-collapsed'); toggle.textContent='Expand'; }
    else{ wn.classList.remove('mm-wn-collapsed'); toggle.textContent='Collapse'; }
    try{ localStorage.setItem(LS_KEY, collapsed ? '1' : '0'); }catch(e){}
  }
  toggle?.addEventListener('click', ()=>{
    const now = wn.classList.contains('mm-wn-collapsed'); // invert
    setCollapsed(!now);
  });

  // Default: collapsed unless user expanded it before
  let collapsedDefault = true;
  try{
    const saved = localStorage.getItem(LS_KEY);
    if(saved === null) setCollapsed(collapsedDefault);
    else setCollapsed(saved === '1');
  }catch(e){ setCollapsed(collapsedDefault); }
})();
</script>
